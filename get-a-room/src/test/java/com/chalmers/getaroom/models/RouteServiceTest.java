package com.chalmers.getaroom.models;

import com.chalmers.getaroom.models.objects.Location;
import com.chalmers.getaroom.models.objects.Route;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.junit.jupiter.api.Test;

import java.io.IOException;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

public class RouteServiceTest {
    @Test
    void getRoute_shouldReturnProperRoute() throws IOException {
        ChalmersMapsAPIInterface api = mock(ChalmersMapsAPIInterface.class);

        JsonObject jObj1 = JsonParser.parseString("{\"description\":\"\",\"items\":{\"routes\":[{\"legs\":[{\"steps\":[{\"intersections\":[{\"out\":0,\"entry\":[true],\"location\":[11.975163,57.696482],\"bearings\":[358]},{\"out\":0,\"in\":1,\"entry\":[true,false,true],\"location\":[11.975154,57.696595],\"bearings\":[45,180,240]}],\"driving_side\":\"right\",\"geometry\":\"cmo`mBu~{yUaFP{HmOyCiK\",\"duration\":36.4,\"distance\":50.6,\"name\":\"Ernst Wigforss Allé\",\"weight\":36.4,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":358,\"location\":[11.975163,57.696482],\"type\":\"depart\",\"bearing_before\":0,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.975614,57.69683],\"bearings\":[150,240,330]}],\"driving_side\":\"right\",\"geometry\":\"{bp`mB{z|yUiDzE\",\"duration\":8.3,\"distance\":11.5,\"name\":\"Rektor Ohlons Gångväg\",\"weight\":8.3,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":324,\"location\":[11.975614,57.69683],\"type\":\"end of road\",\"bearing_before\":52,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.975504,57.696915],\"bearings\":[45,150,225,330]}],\"driving_side\":\"right\",\"geometry\":\"ehp`mB_t|yUn@jB\",\"duration\":3,\"distance\":4.2,\"name\":\"\",\"weight\":3,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":229,\"location\":[11.975504,57.696915],\"type\":\"turn\",\"bearing_before\":324,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":0,\"entry\":[false,true,true],\"location\":[11.97545,57.696891],\"bearings\":[45,225,330]}],\"driving_side\":\"right\",\"geometry\":\"ufp`mBsp|yUgSx[eB]\",\"duration\":36.7,\"distance\":51,\"name\":\"Götabergsgatan\",\"weight\":36.7,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":322,\"location\":[11.97545,57.696891],\"type\":\"turn\",\"bearing_before\":229,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.975004,57.697266],\"bearings\":[90,195,315]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.974485,57.697552],\"bearings\":[45,135,240,330]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.973076,57.698591],\"bearings\":[45,150,225,315]}],\"driving_side\":\"right\",\"geometry\":\"c~p`mBwt{yUkArG}I`PqCvEcFdFkCrEmt@fiA}Td_@\",\"duration\":172.9,\"distance\":237.4,\"name\":\"Götabergsgatan\",\"weight\":172.9,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":316,\"location\":[11.975004,57.697266],\"type\":\"continue\",\"bearing_before\":8,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":1,\"in\":0,\"entry\":[false,true,true],\"location\":[11.972561,57.698942],\"bearings\":[135,255,330]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.971963,57.698858],\"bearings\":[15,75,165,270]}],\"driving_side\":\"right\",\"geometry\":\"{ft`mBa|vyUtAvKpArWJnFIlDYzB}ClG\",\"duration\":47,\"distance\":65.1,\"name\":\"Universitetsplatsen\",\"weight\":47,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":247,\"location\":[11.972561,57.698942],\"type\":\"turn\",\"bearing_before\":320,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.971559,57.698949],\"bearings\":[15,135,240]}],\"driving_side\":\"right\",\"geometry\":\"igt`mBm}tyUbLj_@\",\"duration\":27.8,\"distance\":38.6,\"name\":\"Universitetsplatsen\",\"weight\":27.8,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":232,\"location\":[11.971559,57.698949],\"type\":\"end of road\",\"bearing_before\":317,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":3,\"in\":0,\"entry\":[false,true,true,true],\"location\":[11.971041,57.698739],\"bearings\":[60,135,225,315]}],\"driving_side\":\"right\",\"geometry\":\"ezs`mBa}syUiJvO\",\"duration\":18.5,\"distance\":25.7,\"name\":\"Universitetsplatsen\",\"weight\":18.5,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":320,\"location\":[11.971041,57.698739],\"type\":\"continue\",\"bearing_before\":232,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.970773,57.69892],\"bearings\":[30,135,225,315]},{\"out\":0,\"in\":1,\"entry\":[true,false,true],\"location\":[11.970728,57.69895],\"bearings\":[15,135,225]}],\"driving_side\":\"right\",\"geometry\":\"oet`mBilsyU{@xAuAu@yAA\",\"duration\":10.3,\"distance\":14.3,\"name\":\"Vasagatan\",\"weight\":10.3,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":320,\"location\":[11.970773,57.69892],\"type\":\"turn\",\"bearing_before\":320,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.970756,57.699038],\"bearings\":[60,195,315]},{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.970571,57.699157],\"bearings\":[45,135,315]}],\"driving_side\":\"right\",\"geometry\":\"{lt`mBgksyUeBbDgClEuAfEwAjE}LpUaNnS\",\"duration\":71,\"distance\":98.6,\"name\":\"Vasaplatsen\",\"weight\":71,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":319,\"location\":[11.970756,57.699038],\"type\":\"turn\",\"bearing_before\":8,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":1,\"in\":0,\"entry\":[false,true,true],\"location\":[11.96968,57.699708],\"bearings\":[150,315,330]},{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.969242,57.700031],\"bearings\":[60,150,330]}],\"driving_side\":\"right\",\"geometry\":\"wvu`mB_hqyU_L`Q[bAiEdF{MhR\",\"duration\":55.2,\"distance\":76.7,\"name\":\"Vasaplatsen\",\"weight\":55.2,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":322,\"location\":[11.96968,57.699708],\"type\":\"fork\",\"bearing_before\":323,\"modifier\":\"slight right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.968933,57.700269],\"bearings\":[60,150,240,330]},{\"out\":2,\"in\":0,\"entry\":[false,true,true,true],\"location\":[11.968723,57.700213],\"bearings\":[60,165,255,330]}],\"driving_side\":\"right\",\"geometry\":\"yyv`mBiyoyUXvAX~AXdB`@dC^|C\",\"duration\":13.7,\"distance\":19,\"name\":\"\",\"weight\":13.7,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":241,\"location\":[11.968933,57.700269],\"type\":\"turn\",\"bearing_before\":324,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":0,\"entry\":[false,true,true],\"location\":[11.968644,57.700197],\"bearings\":[75,165,330]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.968506,57.700334],\"bearings\":[75,150,255,330]},{\"out\":2,\"in\":0,\"entry\":[false,true,true],\"location\":[11.967767,57.700757],\"bearings\":[105,180,300]}],\"driving_side\":\"right\",\"geometry\":\"iuv`mBggoyU}BdBUVOh@KZaBnA}AdAkA|AaHxJkBzCq@xAiA~BsAnFa@zBc@dE}@jFeBnE\",\"duration\":72.1,\"distance\":100.1,\"name\":\"\",\"weight\":72.1,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":331,\"location\":[11.968644,57.700197],\"type\":\"end of road\",\"bearing_before\":248,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.967545,57.700839],\"bearings\":[60,135,240,315]}],\"driving_side\":\"right\",\"geometry\":\"m}w`mBqbmyUn^hrB\",\"duration\":88.7,\"distance\":123.2,\"name\":\"Nya Allén\",\"weight\":88.7,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":241,\"location\":[11.967545,57.700839],\"type\":\"turn\",\"bearing_before\":309,\"modifier\":\"left\"}},{\"intersections\":[{\"in\":0,\"entry\":[true],\"location\":[11.9657,57.700335],\"bearings\":[63]}],\"driving_side\":\"right\",\"geometry\":\"}}v`mBgoiyU\",\"duration\":0,\"distance\":0,\"name\":\"Nya Allén\",\"weight\":0,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":0,\"bearing_before\":243,\"type\":\"arrive\",\"location\":[11.9657,57.700335]}}],\"weight\":661.6,\"distance\":916,\"summary\":\"Götabergsgatan, Vasaplatsen\",\"duration\":661.6}],\"weight_name\":\"duration\",\"weight\":661.6,\"distance\":916,\"duration\":661.6}]}}").getAsJsonObject();
        when(api.route(new Location(57.696484034673915, 11.975264592149706), new Location(57.700295142972465, 11.965737593691228))).thenReturn(jObj1);

        RouteServiceInterface routeService = new RouteService(api);

        try {
            Route route = routeService.getRoute(new Location(57.696484034673915, 11.975264592149706), new Location(57.700295142972465, 11.965737593691228));
            assertNotNull(route);
        } catch (IOException e) {
            fail(e);
        }

    }

    @Test
    void getWalkingDistance() throws IOException {
        ChalmersMapsAPIInterface api = mock(ChalmersMapsAPIInterface.class);

        JsonObject jObj1 = JsonParser.parseString("{\"description\":\"\",\"items\":{\"routes\":[{\"legs\":[{\"steps\":[{\"intersections\":[{\"out\":0,\"entry\":[true],\"location\":[11.975163,57.696482],\"bearings\":[358]},{\"out\":0,\"in\":1,\"entry\":[true,false,true],\"location\":[11.975154,57.696595],\"bearings\":[45,180,240]}],\"driving_side\":\"right\",\"geometry\":\"cmo`mBu~{yUaFP{HmOyCiK\",\"duration\":36.4,\"distance\":50.6,\"name\":\"Ernst Wigforss Allé\",\"weight\":36.4,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":358,\"location\":[11.975163,57.696482],\"type\":\"depart\",\"bearing_before\":0,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.975614,57.69683],\"bearings\":[150,240,330]}],\"driving_side\":\"right\",\"geometry\":\"{bp`mB{z|yUiDzE\",\"duration\":8.3,\"distance\":11.5,\"name\":\"Rektor Ohlons Gångväg\",\"weight\":8.3,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":324,\"location\":[11.975614,57.69683],\"type\":\"end of road\",\"bearing_before\":52,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.975504,57.696915],\"bearings\":[45,150,225,330]}],\"driving_side\":\"right\",\"geometry\":\"ehp`mB_t|yUn@jB\",\"duration\":3,\"distance\":4.2,\"name\":\"\",\"weight\":3,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":229,\"location\":[11.975504,57.696915],\"type\":\"turn\",\"bearing_before\":324,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":0,\"entry\":[false,true,true],\"location\":[11.97545,57.696891],\"bearings\":[45,225,330]}],\"driving_side\":\"right\",\"geometry\":\"ufp`mBsp|yUgSx[eB]\",\"duration\":36.7,\"distance\":51,\"name\":\"Götabergsgatan\",\"weight\":36.7,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":322,\"location\":[11.97545,57.696891],\"type\":\"turn\",\"bearing_before\":229,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.975004,57.697266],\"bearings\":[90,195,315]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.974485,57.697552],\"bearings\":[45,135,240,330]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.973076,57.698591],\"bearings\":[45,150,225,315]}],\"driving_side\":\"right\",\"geometry\":\"c~p`mBwt{yUkArG}I`PqCvEcFdFkCrEmt@fiA}Td_@\",\"duration\":172.9,\"distance\":237.4,\"name\":\"Götabergsgatan\",\"weight\":172.9,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":316,\"location\":[11.975004,57.697266],\"type\":\"continue\",\"bearing_before\":8,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":1,\"in\":0,\"entry\":[false,true,true],\"location\":[11.972561,57.698942],\"bearings\":[135,255,330]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.971963,57.698858],\"bearings\":[15,75,165,270]}],\"driving_side\":\"right\",\"geometry\":\"{ft`mBa|vyUtAvKpArWJnFIlDYzB}ClG\",\"duration\":47,\"distance\":65.1,\"name\":\"Universitetsplatsen\",\"weight\":47,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":247,\"location\":[11.972561,57.698942],\"type\":\"turn\",\"bearing_before\":320,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.971559,57.698949],\"bearings\":[15,135,240]}],\"driving_side\":\"right\",\"geometry\":\"igt`mBm}tyUbLj_@\",\"duration\":27.8,\"distance\":38.6,\"name\":\"Universitetsplatsen\",\"weight\":27.8,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":232,\"location\":[11.971559,57.698949],\"type\":\"end of road\",\"bearing_before\":317,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":3,\"in\":0,\"entry\":[false,true,true,true],\"location\":[11.971041,57.698739],\"bearings\":[60,135,225,315]}],\"driving_side\":\"right\",\"geometry\":\"ezs`mBa}syUiJvO\",\"duration\":18.5,\"distance\":25.7,\"name\":\"Universitetsplatsen\",\"weight\":18.5,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":320,\"location\":[11.971041,57.698739],\"type\":\"continue\",\"bearing_before\":232,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.970773,57.69892],\"bearings\":[30,135,225,315]},{\"out\":0,\"in\":1,\"entry\":[true,false,true],\"location\":[11.970728,57.69895],\"bearings\":[15,135,225]}],\"driving_side\":\"right\",\"geometry\":\"oet`mBilsyU{@xAuAu@yAA\",\"duration\":10.3,\"distance\":14.3,\"name\":\"Vasagatan\",\"weight\":10.3,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":320,\"location\":[11.970773,57.69892],\"type\":\"turn\",\"bearing_before\":320,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.970756,57.699038],\"bearings\":[60,195,315]},{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.970571,57.699157],\"bearings\":[45,135,315]}],\"driving_side\":\"right\",\"geometry\":\"{lt`mBgksyUeBbDgClEuAfEwAjE}LpUaNnS\",\"duration\":71,\"distance\":98.6,\"name\":\"Vasaplatsen\",\"weight\":71,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":319,\"location\":[11.970756,57.699038],\"type\":\"turn\",\"bearing_before\":8,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":1,\"in\":0,\"entry\":[false,true,true],\"location\":[11.96968,57.699708],\"bearings\":[150,315,330]},{\"out\":2,\"in\":1,\"entry\":[true,false,true],\"location\":[11.969242,57.700031],\"bearings\":[60,150,330]}],\"driving_side\":\"right\",\"geometry\":\"wvu`mB_hqyU_L`Q[bAiEdF{MhR\",\"duration\":55.2,\"distance\":76.7,\"name\":\"Vasaplatsen\",\"weight\":55.2,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":322,\"location\":[11.96968,57.699708],\"type\":\"fork\",\"bearing_before\":323,\"modifier\":\"slight right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.968933,57.700269],\"bearings\":[60,150,240,330]},{\"out\":2,\"in\":0,\"entry\":[false,true,true,true],\"location\":[11.968723,57.700213],\"bearings\":[60,165,255,330]}],\"driving_side\":\"right\",\"geometry\":\"yyv`mBiyoyUXvAX~AXdB`@dC^|C\",\"duration\":13.7,\"distance\":19,\"name\":\"\",\"weight\":13.7,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":241,\"location\":[11.968933,57.700269],\"type\":\"turn\",\"bearing_before\":324,\"modifier\":\"left\"}},{\"intersections\":[{\"out\":2,\"in\":0,\"entry\":[false,true,true],\"location\":[11.968644,57.700197],\"bearings\":[75,165,330]},{\"out\":3,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.968506,57.700334],\"bearings\":[75,150,255,330]},{\"out\":2,\"in\":0,\"entry\":[false,true,true],\"location\":[11.967767,57.700757],\"bearings\":[105,180,300]}],\"driving_side\":\"right\",\"geometry\":\"iuv`mBggoyU}BdBUVOh@KZaBnA}AdAkA|AaHxJkBzCq@xAiA~BsAnFa@zBc@dE}@jFeBnE\",\"duration\":72.1,\"distance\":100.1,\"name\":\"\",\"weight\":72.1,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":331,\"location\":[11.968644,57.700197],\"type\":\"end of road\",\"bearing_before\":248,\"modifier\":\"right\"}},{\"intersections\":[{\"out\":2,\"in\":1,\"entry\":[true,false,true,true],\"location\":[11.967545,57.700839],\"bearings\":[60,135,240,315]}],\"driving_side\":\"right\",\"geometry\":\"m}w`mBqbmyUn^hrB\",\"duration\":88.7,\"distance\":123.2,\"name\":\"Nya Allén\",\"weight\":88.7,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":241,\"location\":[11.967545,57.700839],\"type\":\"turn\",\"bearing_before\":309,\"modifier\":\"left\"}},{\"intersections\":[{\"in\":0,\"entry\":[true],\"location\":[11.9657,57.700335],\"bearings\":[63]}],\"driving_side\":\"right\",\"geometry\":\"}}v`mBgoiyU\",\"duration\":0,\"distance\":0,\"name\":\"Nya Allén\",\"weight\":0,\"mode\":\"walking\",\"maneuver\":{\"bearing_after\":0,\"bearing_before\":243,\"type\":\"arrive\",\"location\":[11.9657,57.700335]}}],\"weight\":661.6,\"distance\":916,\"summary\":\"Götabergsgatan, Vasaplatsen\",\"duration\":661.6}],\"weight_name\":\"duration\",\"weight\":661.6,\"distance\":916,\"duration\":661.6}]}}").getAsJsonObject();
        when(api.route(new Location(57.696484034673915, 11.975264592149706), new Location(57.700295142972465, 11.965737593691228))).thenReturn(jObj1);

        RouteServiceInterface routeService = new RouteService(api);

        try {
            double walkingDistance = routeService.getWalkingDistance(new Location(57.696484034673915, 11.975264592149706), new Location(57.700295142972465, 11.965737593691228));
            assertEquals(916, walkingDistance);
        } catch (IOException e) {
            fail(e);
        }

    }

    @Test
    void getBirdsDistance() {
        ChalmersMapsAPIInterface api = mock(ChalmersMapsAPIInterface.class);
        RouteService routeService = new RouteService(api);

        // From external tool: https://www.calculator.net/distance-calculator.html
        // Might differ in the earth radius used, uses an allowedDiff:
        final int allowedDiff = 5;

        // Chalmers tram stop: 57.6899025, 11.9731912
        final Location origin = new Location(57.6899025, 11.9731912);
        // Linsen: 57.6877801, 11.9788758
        final Location destination = new Location(57.6877801, 11.9788758);
        // Should be: 0.4133km = 413.3m
        final int distFromExtCalculatorRounded = 413;

        final double dist = routeService.getBirdsDistance(origin, destination);
        final long distRounded = Math.round(dist);
        assertTrue(Math.abs(distFromExtCalculatorRounded - distRounded) < allowedDiff);
    }
}
